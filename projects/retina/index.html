<!DOCTYPE html>
<html lang="en-us"><head>
  <meta charset="utf-8">
<meta http-equiv="content-type" content="text/html">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title itemprop="name">Retinal Fundus Image Enhancement | Dibyajyoti Jena</title>
<meta property="og:title" content="Retinal Fundus Image Enhancement | Dibyajyoti Jena" />
<meta name="twitter:title" content="Retinal Fundus Image Enhancement | Dibyajyoti Jena" />
<meta itemprop="name" content="Retinal Fundus Image Enhancement | Dibyajyoti Jena" />
<meta name="application-name" content="Retinal Fundus Image Enhancement | Dibyajyoti Jena" />
<meta property="og:site_name" content="Awesome hugo blog" />

<meta name="description" content="Minimal Hugo blog theme with light and dark mode support">
<meta itemprop="description" content="Minimal Hugo blog theme with light and dark mode support" />
<meta property="og:description" content="Minimal Hugo blog theme with light and dark mode support" />
<meta name="twitter:description" content="Minimal Hugo blog theme with light and dark mode support" />

<meta property="og:locale" content="en-us" />
<meta name="language" content="en-us" />



  <meta itemprop="image" content="https://coolman-spaceman.github.io/" />
  <meta property="og:image" content="https://coolman-spaceman.github.io/" />
  <meta name="twitter:image" content="https://coolman-spaceman.github.io/" />
  <meta name="twitter:image:src" content="https://coolman-spaceman.github.io/" />




  <meta name="generator" content="Hugo 0.92.2" />

  

  <link rel="canonical" href="https://coolman-spaceman.github.io/projects/retina/"><link href="/sass/main.min.0eebb6db90b4ec9f4444ef402f08421ee056025ba860df3d749a9f299d472008.css" rel="stylesheet"><link href="/code-highlight.min.706d31975fec544a864cb7f0d847a73ea55ca1df91bf495fd12a177138d807cf.css" rel="stylesheet">

  

  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png">
  <link rel="manifest" href="/images/favicon/site.webmanifest">
  <link rel="mask-icon" href="/images/favicon/safari-pinned-tab.svg" color="#5bbad5">
  <link rel="shortcut icon" href="/images/favicon/favicon.ico">
  <meta name="msapplication-TileColor" content="#2b5797">
  <meta name="msapplication-config" content="/images/favicon/browserconfig.xml">
  <meta name="theme-color" content="#ffffff">

  
  <link rel="icon" type="image/svg+xml" href="/images/favicon/favicon.svg">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css" integrity="sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0" crossorigin="anonymous">


<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js" integrity="sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4" crossorigin="anonymous"></script>


<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
            delimiters: [
                {left: "$$", right: "$$", display: true},
                {left: "$", right: "$", display: false}
            ]
        });
    });
</script>

    </head><body data-theme = "dark" class="notransition">
<script src="https://coolman-spaceman.github.io/js/themeLoader.min.0ea9375d525d6f19779c6d41cfaf9e166e47014d9734ff071daad3a4ff12d147.js"></script><div class="navbar" role="navigation">
  <nav class="menu" aria-label="Main Navigation">
    <a href="/" class="logo">
      <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" 
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" 
stroke-linejoin="round" class="feather feather-home">
<title>Home</title>
<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
<polyline points="9 22 9 12 15 12 15 22"></polyline>
</svg>
    </a>
    <input type="checkbox" id="menu-trigger" class="menu-trigger" />
    <label for="menu-trigger">
      <span class="menu-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" stroke="currentColor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7L3.40726 7"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488L3.49301 3.51488"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"></path><path stroke-linecap="round" stroke-linejoin="round" d="M0.5 12.5V1.5C0.5 0.947715 0.947715 0.5 1.5 0.5H12.5C13.0523 0.5 13.5 0.947715 13.5 1.5V12.5C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C0.947715 13.5 0.5 13.0523 0.5 12.5Z"></path></svg>
      </span>
    </label>

    <div class="trigger">
      <ul class="trigger-container">
        
        
          <li>
            <a 
            class="menu-link "
            href="/">
            Home
            </a>
            
          </li>
        
          <li>
            <a 
            class="menu-link "
            href="/posts/">
            Posts
            </a>
            
          </li>
        
          <li>
            <a 
            class="menu-link active"
            href="/projects/">
            Projects
            </a>
            
          </li>
        
          <li>
            <a 
            class="menu-link "
            href="/publications/">
            Publications
            </a>
            
          </li>
        
          <li>
            <a 
            class="menu-link "
            href="/lectures/">
            ML Lectures
            </a>
            
          </li>
        
          <li>
            <a 
            class="menu-link "
            href="/about/">
            About
            </a>
            
          </li>
        
        <li class="menu-separator">
          <span>|</span>
        </li>
      </ul>
      <a id="mode" href="#">
        <svg xmlns="http://www.w3.org/2000/svg" class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
        <svg xmlns="http://www.w3.org/2000/svg" class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
      </a>
    </div>
  </nav>
</div>

<div class="wrapper post">
    <main class="page-content" aria-label="Content">
        <article>
            <header class="header">
                <h1 class="header-title">Retinal Fundus Image Enhancement</h1>
                
                <div class="post-meta">
                    <time datetime="2023-11-22T10:33:26&#43;05:30" itemprop="datePublished"> Nov 22, 2023 </time>
                </div>
            </header>
            <div class="page-content">
                <h5>Retinal Fundus Image Enhancement With Image Decomposition and Visual Adaptation</h5>
<figure>
  <p align="center"><img class=scaled src="/postimages/post3/img.webp">
  <figcaption>A random calming image to show I have no experience in writing content</figcaption>
</figure>
<p>Retinal fundus photography is a non-invasive method to check for symptoms and other features related to diseases like diabetic retinopathy, age-related macular degeneration, cardiovascular
disease. The main features to look out for are the vascular structure, lesions, optic disc, microaneurysms, etc. These depend on high quality fundus images to be processed properly.</p>
<p>However, many such images are clinically unsatisfactory because of human error and electronic noise in the imaging instrument. The main problems are: non-uniform illumination, low contrast and noise.</p>
<figure>
 <div class="column">
    <p align="center"><img class=scaled src="/projectimages/retina/01_test.png" width="200">
<img class=scaled src="/projectimages/retina/03_test.png" width="200">
</div>
  <figcaption>These two fundus images signify low contrast, uneven illumination and
noisy/blurred features.</figcaption>
</figure>
<p>The aim of this project is to:</p>
<ul>
<li>remove electronic noise</li>
<li>correct uneven illumination of background</li>
<li>contrast correction of features</li>
</ul>
<h5>Previous Methods</h5>
Histogram Equalisation(HE) and CLAHE:
HE is performed over the entire image’s histogram and thus works over the entire
contrast, rendering it in-effective for fundus image enhancements, where the contrast
improvement requirements are regional.
<p>CLAHE performs better in this regard, because it can suppress noise in near-constant
regions. Illumination correction happens simultaneously in this step.</p>
<ul>
<li>
<p>M. Foracchia, et al.: Normalise luminosity and image contrast in different steps
Fundus images are considered to be a superposition of background and foreground
steps, with luminosity and contrast being a feature of the background.</p>
</li>
<li>
<p>Zhou et al.: Luminosity correction in the HSV space and contrast correction in color
space, then recombine to form the enhanced fundus image.</p>
</li>
</ul>
<figure>
 <div class="column">
    <p align="center"><img class=scaled src="/projectimages/retina/01_clahe.png" width="200">
<img class=scaled src="/projectimages/retina/03_clahe.png" width="200">
</div>
  <figcaption>Color correction of the above two images using CLAHE. It shows
improvement in vascular features but very less improvement in illumination.</figcaption>
</figure>
<h3>Method</h3>
<p>Total variation based structure decomposition method is used to separate the image into high frequency and low frequency parts. The high frequency part can be thought of containing noise and/or details and the low frequency part is the base and/or structure.</p>
<p>There are two decomposition steps:</p>
<ul>
<li>
<p>Image -&gt; Structure and Noise</p>
</li>
<li>
<p>Structure -&gt; Base and Detail</p>
<p>Noise is discarded.</p>
</li>
</ul>
<h5>1st Decomposition</h5>
The input image is a combination of noise and structure layers. 
\begin{equation}
    I^c(x,y) = I^c_{noise}(x,y) + I^c_{structure}(x,y), c \in (R,G,B)
\end{equation}
<p>Noise corresponds to high frequency. TV decomposition method employs a cost function minimization to remove the high frequency layer:</p>
<p>\begin{equation}
I^c_{structure}(x,y) = arg min_I \sum_{x,y}^{}\left [ (I(x,y)-I^c(x,y))^2 + \lambda^c\Delta I(x,y) \right ]
\end{equation}</p>
<p>In the above equation there are two terms. The first term is called the variation term: which is simply the squared difference between I(x,y) and the input image. The 2nd term is called the regularisation term, which corresponds to the gradient of I.</p>
<p>The physical significance is that, to minimize both terms, the output needs to be as close to the input as possible but should not have high frequency edges. Regularisation term $\lambda^c$ corresponds to the degree of smoothness required for the operation, over every color layer in R, G, B.</p>
<p>So for the first step, equations 1 and 2 are followed. $\lambda^c$ is calculated for each color layer $I^c$ from the following equation:</p>
<p>\begin{equation}
\lambda^c = \sqrt{\pi/2}\frac{1}{6(W-2)(H-2)}\sum_{x,y}^{}\left | (I^c\star N_s)(x,y) \right |
\end{equation}</p>
<p>\begin{equation}
N_s =    \begin{bmatrix}
1 &amp; -2 &amp; 1\\
-2 &amp; 4 &amp;-2 \\
1 &amp;-2  &amp; 1
\end{bmatrix}
\end{equation}</p>
<p>W and H correspond to width and height of the image and c refers to each color layer R,G,B.
Scikit-Image provides an inbult function to implement TV decomposition and the same has been used in this process.</p>
<figure>
 <div class="column">
    <p align="center"><img class=scaled src="/projectimages/retina/01_test.png" width="200">
<img class=scaled src="/projectimages/retina/structure.png" width="200">
<img class=scaled src="/projectimages/retina/01_noise.png" width="200">
</div>
  <figcaption>Input Image, Structure Layer and Noise Layer in order. Structure is moved forward for processing, noise is discarded.</figcaption>
</figure>
<h5>Second decomposition</h5>
Moving on to the 2nd step of decomposition, the same method is used. But this time, the practical value of $\lambda $ is kept constant for all layers at 0.3.
<p>\begin{equation}
I^c_{structure}(x,y) = I^c_{base}(x,y) + I^c_{details}(x,y), c \in (R,G,B)
\end{equation}</p>
<p>Figure below shows the extracted base and detail layers. Base contains illumination information and detail contains the feature information like vascular structure, optic disc, lesions, etc.</p>
<figure>
 <div class="column">
    <p align="center">
<img class=scaled src="/projectimages/retina/01_base.png" width="200">
<img class=scaled src="/projectimages/retina/01_detail.png" width="200">
</div>
  <figcaption>Base and Detail layer</figcaption>
</figure>
<h5>Illuminant Correction</h5>
Uneven illuminant in the base layer is the low frequency information. For illuminant correction, first the RGB space is converted to HSV space and V layer is extracted as luminance information, denoted as  $L_{in}(x,y)$. 
<p>Correction is done by the following equation, where n is the contrast enhancement parameter. It is set to 1 for all experiments given.</p>
<p>\begin{equation}
L_{out} = \frac{L_{in}^n}{L_{in}^n+\sigma_g^n}
\end{equation}</p>
<p>Visual adaptation level is determined by $\sigma_g$,which is a
global adaptation level estimated from the whole luminance image from the equation below:
\begin{equation}
\sigma_g = \frac{M_g}{1+exp(S_g)}
\end{equation}</p>
<p>where $M_g$ and $S_g$ are the mean and standard deviation of the entire $L_{in}$ respectively.
Finally, corrected base is found out by transferring the HSV space back to RGB space.</p>
<h5>Detail Enhancement and Fusion</h5>
<p>From a clinical perspective, R channel contains veins and G channel contains arteries. Blue channel does not appear to contain any significant detail, but has some artefacts. Thus we can improve the contrast of R and G channels and ignore B channel in detail images. The final image is obtained by a weighted sum of corrected based layer and enhanced detail layer.</p>
<p>Enhancing detail layer: R and G detail layers are passed through a Gaussian filter, keeping in mind that a Gaussian filter is essentially a low pass filter and it will somewhat blur the edges of the veins, making them thicker and more prominent, while removing other noise and artefacts. The execution of the next step differs a bit from the original reference paper. The following equation is used for the final output:</p>
<p>\begin{equation}
I_{out}^c = I_{correct-base}^c + \alpha^c I_{enhance-details}^c
\end{equation}</p>
<h3>Results</h3>
<figure>
 <div class="column">
    <p align="center"><img class=scaled src="/projectimages/retina/01_test.png" width="150">
<img class=scaled src="/projectimages/retina/01_red.png" width="150">
<img class=scaled src="/projectimages/retina/01_green.png" width="150">
<img class=scaled src="/projectimages/retina/01_blue.png" width="150">
</div>
  <figcaption>a. Original Image b. Red detail layer c. Green detail layer d. Blue detail layer</figcaption>
</figure>
<figure>
 <div class="column">
    <p align="center"><img class=scaled src="/projectimages/retina/01_base.png" width="150">
<img class=scaled src="/projectimages/retina/01_base_new.png" width="150">
<img class=scaled src="/projectimages/retina/01_detail.png" width="150">
<img class=scaled src="/projectimages/retina/01_detail_new.png" width="150">
</div>
  <figcaption>a. Base layer b. Enhanced base layer c. Detail layer d. Enhanced detail
layer</figcaption>
</figure>
<h5>Results against CLAHE</h5>
<figure>
 <div class="column">
    <p align="center"><img class=scaled src="/projectimages/retina/01_test.png" width="200">
<img class=scaled src="/projectimages/retina/03_test.png" width="200">
<img class=scaled src="/projectimages/retina/04_test.png" width="200">
</div>
</figure>
<figure>
 <div class="column">
    <p align="center"><img class=scaled src="/projectimages/retina/01_clahe.png" width="200">
<img class=scaled src="/projectimages/retina/03_clahe.png" width="200">
<img class=scaled src="/projectimages/retina/04_clahe.png" width="200">
</div>
</figure>
<figure>
 <div class="column">
    <p align="center"><img class=scaled src="/projectimages/retina/01_output.png" width="200">
<img class=scaled src="/projectimages/retina/03_output.png" width="200">
<img class=scaled src="/projectimages/retina/04_output.png" width="200">
</div>
 <figcaption>Row wise: a. Original Image b. CLAHE enhanced c. Proposed method</figcaption>
</figure>
<h5>Discusion</h5>
The process discussed in this project shows a streamlined method to
enhance fundus images through three distinct steps: image decomposition,
illumination correction/details enhancement and then weighted addition.
<p><strong>This process provides more control to the user in each layer, such as
weights value in the final merge step, to decide which layer should be
highlighted more according to the end goal.</strong></p>
<h3>Python Code</h3>
<p>Written in Jupyter Notebook</p>
<p>For the datasets, download the images from: <a href="https://www.dropbox.com/sh/z4hbbzqai0ilqht/AAARqnQhjq3wQcSVFNR__6xNa?dl=0">DRIVE</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python">
<span class="c1"># IMPORT NECESSARY LIBRARIES</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">cv2</span> 
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">skimage.restoration</span> <span class="kn">import</span> <span class="n">denoise_tv_chambolle</span>
</code></pre></div><p><strong>CLAHE</strong></p>
<p>Trying CLAHE as a contrast correction technique</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="c1">## CORRECT EACH COLOR LAYER USING CLAHE</span>
<span class="k">def</span> <span class="nf">save_clahe_images</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
    <span class="c1">#take image path as argument</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
    <span class="n">blue</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">red</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="c1"># split channels</span>
    
    <span class="n">clahe</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">createCLAHE</span><span class="p">(</span><span class="n">clipLimit</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">tileGridSize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
    <span class="n">cred</span> <span class="o">=</span> <span class="n">clahe</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">red</span><span class="p">)</span>   <span class="c1">## apply clahe to all channels</span>
    <span class="n">cgreen</span> <span class="o">=</span> <span class="n">clahe</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">green</span><span class="p">)</span>
    <span class="n">cblue</span> <span class="o">=</span> <span class="n">clahe</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">blue</span><span class="p">)</span>
    
    <span class="n">cimg</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">cblue</span><span class="p">,</span> <span class="n">cgreen</span><span class="p">,</span> <span class="n">cred</span><span class="p">])</span> <span class="c1"># merge back clahe channels</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">blue</span><span class="p">,</span><span class="n">green</span><span class="p">,</span><span class="n">red</span><span class="p">])</span>
    
    <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s1">&#39;saved/&#39;</span><span class="o">+</span><span class="n">num</span><span class="o">+</span><span class="s1">&#39;_clahe.png&#39;</span><span class="p">,</span> <span class="n">cimg</span><span class="p">)</span> <span class="c1"># write back clahe image</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s1">&#39;saved/&#39;</span><span class="o">+</span><span class="n">num</span><span class="o">+</span><span class="s1">&#39;_test.png&#39;</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>   <span class="c1"># write back image</span>

    <span class="n">cimg</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">cimg</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_RGB2BGR</span><span class="p">)</span> <span class="c1"># Correct order of channels</span>
    <span class="k">return</span> <span class="n">cimg</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="n">number</span> <span class="o">=</span> <span class="s1">&#39;01&#39;</span>
<span class="n">img_path</span> <span class="o">=</span> <span class="s1">&#39;test/images/&#39;</span><span class="o">+</span><span class="n">number</span><span class="o">+</span><span class="s1">&#39;_test.tif&#39;</span>
<span class="n">cimg</span> <span class="o">=</span> <span class="n">save_clahe_images</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Original image&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cimg</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;CLAHE&#39;</span><span class="p">)</span>
</code></pre></div><figure>
 <div class="column">
    <p align="center"><img class=scaled src="/projectimages/retina/01_test.png" width="200">
<img class=scaled src="/projectimages/retina/01_clahe.png" width="200">
</div>
  <figcaption>a. Original Image b. CLAHE</figcaption>
</figure>
<p><strong>1st Decomposition</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="c1">## FUNCTION TO CALCULATE LAMBDA_c FOR REGULARIZATION TERM</span>

<span class="k">def</span> <span class="nf">calculate_lamda</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
    <span class="n">W</span><span class="p">,</span> <span class="n">H</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>  
    <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
    <span class="n">lamdac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">H</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">filter2D</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">lamdac</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Convert color range 0-1 to 0-255 for storing images</span>
<span class="c1"># Images can not be stored in 0-1 color range</span>
<span class="k">def</span> <span class="nf">layer_restore</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="o">*</span><span class="mi">255</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">*</span><span class="n">mask</span>
    <span class="k">return</span> <span class="n">image</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">image_restore</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="o">*</span><span class="mi">255</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
    <span class="n">image</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span><span class="n">image</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">],</span><span class="n">image</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">mask</span><span class="p">,</span><span class="n">image</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">mask</span><span class="p">,</span><span class="n">image</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">mask</span>
    <span class="k">return</span> <span class="n">image</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">decomposition</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">mask_path</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">mask_path</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">/</span><span class="mi">255</span>  <span class="c1"># normalise to 0-1 range</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
    
    <span class="n">blue</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">red</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>       <span class="c1"># split the image into color layers</span>
    <span class="n">lamda_r</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">calculate_lamda</span><span class="p">(</span><span class="n">red</span><span class="p">),</span><span class="mi">4</span><span class="p">)</span> <span class="c1"># calculate lambda c for each layer</span>
    <span class="n">lamda_g</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">calculate_lamda</span><span class="p">(</span><span class="n">green</span><span class="p">),</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">lamda_b</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">calculate_lamda</span><span class="p">(</span><span class="n">blue</span><span class="p">),</span><span class="mi">4</span><span class="p">)</span>
    <span class="c1">###################################################################</span>
    <span class="c1">###################### FIRST DECOMPOSITION ########################</span>
    <span class="n">redn</span> <span class="o">=</span> <span class="n">denoise_tv_chambolle</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="n">weight</span> <span class="o">=</span> <span class="n">lamda_r</span><span class="p">)</span>     <span class="c1"># Total Variation method</span>
    <span class="n">greenn</span> <span class="o">=</span> <span class="n">denoise_tv_chambolle</span><span class="p">(</span><span class="n">green</span><span class="p">,</span> <span class="n">weight</span> <span class="o">=</span> <span class="n">lamda_g</span><span class="p">)</span> <span class="c1"># In-built funcion</span>
    <span class="n">bluen</span> <span class="o">=</span> <span class="n">denoise_tv_chambolle</span><span class="p">(</span><span class="n">blue</span><span class="p">,</span> <span class="n">weight</span> <span class="o">=</span> <span class="n">lamda_b</span><span class="p">)</span>   <span class="c1"># Gives structure layer</span>

    <span class="n">noise</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">blue</span><span class="o">-</span><span class="n">bluen</span><span class="p">,</span> <span class="n">green</span><span class="o">-</span><span class="n">greenn</span><span class="p">,</span> <span class="n">red</span><span class="o">-</span><span class="n">redn</span><span class="p">])</span> <span class="c1"># Obtain noise:</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">image_restore</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>                      <span class="c1"># image - structure</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s1">&#39;nbd/&#39;</span><span class="o">+</span><span class="n">num</span><span class="o">+</span><span class="s1">&#39;_noise.png&#39;</span><span class="p">,</span> <span class="n">noise</span><span class="p">)</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>

    <span class="c1">#####################################################################</span>
    <span class="c1">################### SECOND DECOMPOSITION ############################</span>

    <span class="n">rednn</span> <span class="o">=</span> <span class="n">denoise_tv_chambolle</span><span class="p">(</span><span class="n">redn</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>     <span class="c1"># base layer</span>
    <span class="n">greennn</span> <span class="o">=</span> <span class="n">denoise_tv_chambolle</span><span class="p">(</span><span class="n">greenn</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span> <span class="c1"># 2nd decomposition with fixed lambda</span>
    <span class="n">bluenn</span> <span class="o">=</span> <span class="n">denoise_tv_chambolle</span><span class="p">(</span><span class="n">bluen</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="n">redd</span> <span class="o">=</span> <span class="p">(</span><span class="n">redn</span><span class="o">-</span><span class="n">rednn</span><span class="p">)</span>         <span class="c1"># DETAIL LAYERS</span>
    <span class="n">greend</span> <span class="o">=</span> <span class="p">(</span><span class="n">greenn</span><span class="o">-</span><span class="n">greennn</span><span class="p">)</span>
    <span class="n">blued</span> <span class="o">=</span> <span class="p">(</span><span class="n">bluen</span><span class="o">-</span><span class="n">bluenn</span><span class="p">)</span>

    <span class="n">detail</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">blued</span><span class="p">,</span> <span class="n">greend</span><span class="p">,</span> <span class="n">redd</span><span class="p">])</span>
    <span class="n">detail</span> <span class="o">=</span> <span class="n">image_restore</span><span class="p">(</span><span class="n">detail</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s1">&#39;nbd/&#39;</span><span class="o">+</span><span class="n">num</span><span class="o">+</span><span class="s1">&#39;_detail.png&#39;</span><span class="p">,</span> <span class="n">detail</span><span class="p">)</span>
    <span class="n">detail</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">redd</span><span class="p">,</span> <span class="n">greend</span><span class="p">,</span> <span class="n">blued</span><span class="p">])</span>
    
    <span class="n">r</span> <span class="o">=</span> <span class="n">layer_restore</span><span class="p">(</span><span class="n">redd</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">layer_restore</span><span class="p">(</span><span class="n">greend</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">layer_restore</span><span class="p">(</span><span class="n">blued</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s1">&#39;rgb/&#39;</span><span class="o">+</span><span class="n">num</span><span class="o">+</span><span class="s1">&#39;_red.png&#39;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s1">&#39;rgb/&#39;</span><span class="o">+</span><span class="n">num</span><span class="o">+</span><span class="s1">&#39;_green.png&#39;</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s1">&#39;rgb/&#39;</span><span class="o">+</span><span class="n">num</span><span class="o">+</span><span class="s1">&#39;_blue.png&#39;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    

    <span class="n">base</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">bluenn</span><span class="p">,</span> <span class="n">greennn</span><span class="p">,</span> <span class="n">rednn</span><span class="p">])</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">image_restore</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s1">&#39;nbd/&#39;</span><span class="o">+</span><span class="n">num</span><span class="o">+</span><span class="s1">&#39;_base.png&#39;</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">rednn</span><span class="p">,</span> <span class="n">greennn</span><span class="p">,</span> <span class="n">bluenn</span><span class="p">])</span>   
    
    <span class="k">return</span> <span class="n">noise</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">detail</span><span class="p">,</span> <span class="n">mask</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="n">mask_path</span> <span class="o">=</span> <span class="s1">&#39;test/mask/&#39;</span><span class="o">+</span><span class="n">number</span><span class="o">+</span><span class="s1">&#39;_test_mask.png&#39;</span>
<span class="n">noise</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">detail</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">decomposition</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">mask_path</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>
<span class="n">det</span> <span class="o">=</span> <span class="n">image_restore</span><span class="p">(</span><span class="n">detail</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">noise</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;noise&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;base&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">det</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;detail&#39;</span><span class="p">)</span>
</code></pre></div><figure>
 <div class="column">
    <p align="center"><img class=scaled src="/projectimages/retina/01_noise.png" width="200">
<img class=scaled src="/projectimages/retina/01_base.png" width="200">
<img class=scaled src="/projectimages/retina/01_detail.png" width="200">
</div>
  <figcaption>a. Noise b. Base c. Detail</figcaption>
</figure>
<p><strong>Base Illumination Correction</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="c1">## Base Illumination Correction</span>
<span class="k">def</span> <span class="nf">base_enhancement</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
    <span class="n">base32</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;float32&#39;</span><span class="p">)</span>
    <span class="n">hsv</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">base32</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_RGB2HSV</span><span class="p">)</span> <span class="c1"># Convert to HSV</span>
    <span class="n">lum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">hsv</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">])</span>                     <span class="c1"># Pick intensity layer</span>
    <span class="n">lum</span> <span class="o">=</span> <span class="n">lum</span><span class="o">*</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>                              <span class="c1"># mul with mask</span>
    <span class="n">array</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>            <span class="c1"># array of intensities inside the mask</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">lum</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lum</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>

    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>           
    <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>        <span class="c1"># mean of the intensity layer</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>         <span class="c1"># std dev</span>

    <span class="n">sigma</span> <span class="o">=</span> <span class="n">m</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>   <span class="c1"># operations following reference paper</span>
    <span class="n">lum</span> <span class="o">=</span> <span class="n">lum</span><span class="o">/</span><span class="p">(</span><span class="n">lum</span><span class="o">+</span><span class="n">sigma</span><span class="p">)</span>
    <span class="n">hsv</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">lum</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">hsv</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_HSV2RGB</span><span class="p">)</span> <span class="c1"># HSV to RGB</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="n">correct</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">correct</span><span class="p">)</span>
    <span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">correct</span><span class="p">)</span><span class="o">*</span><span class="mi">255</span>
    <span class="n">corr</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">corr</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_RGB2BGR</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s1">&#39;nbd/&#39;</span><span class="o">+</span><span class="n">num</span><span class="o">+</span><span class="s1">&#39;_base_new.png&#39;</span><span class="p">,</span> <span class="n">corr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">correct</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="n">new_base</span> <span class="o">=</span> <span class="n">base_enhancement</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Base&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">new_base</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Corrected Base&#39;</span><span class="p">)</span>
</code></pre></div><figure>
 <div class="column">
    <p align="center"><img class=scaled src="/projectimages/retina/01_base.png" width="200">
<img class=scaled src="/projectimages/retina/01_base_new.png" width="200">
</div>
  <figcaption>a. Base b. Enhanced Base </figcaption>
</figure>
<p><strong>Detail Enhancement</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="c1">## Detail layer enhancement</span>
<span class="k">def</span> <span class="nf">detail_enhancement</span><span class="p">(</span><span class="n">detail</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
    <span class="n">r</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">detail</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">GaussianBlur</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span><span class="o">*</span><span class="mi">6</span> <span class="c1"># improve contrast of red</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">GaussianBlur</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span><span class="o">*</span><span class="mi">6</span> <span class="c1"># improve contrast of green</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>                 <span class="c1"># ignore blue</span>

    <span class="n">det</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">b</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">r</span><span class="p">])</span>              <span class="c1"># merge new detail layer</span>
    <span class="n">det</span> <span class="o">=</span> <span class="n">image_restore</span><span class="p">(</span><span class="n">det</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s1">&#39;nbd/&#39;</span><span class="o">+</span><span class="n">num</span><span class="o">+</span><span class="s1">&#39;_detail_new.png&#39;</span><span class="p">,</span> <span class="n">det</span><span class="p">)</span>
    <span class="n">det</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">det</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">det</span>
<span class="n">det_</span> <span class="o">=</span> <span class="n">image_restore</span><span class="p">(</span><span class="n">detail</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
<span class="n">det</span> <span class="o">=</span> <span class="n">detail_enhancement</span><span class="p">(</span><span class="n">detail</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">det_</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Detail&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">det</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Enhanced Details&#39;</span><span class="p">)</span>
</code></pre></div><figure>
 <div class="column">
    <p align="center"><img class=scaled src="/projectimages/retina/01_detail.png" width="200">
<img class=scaled src="/projectimages/retina/01_detail_new.png" width="200">
</div>
  <figcaption>a. Detail Layer b. Enhanced Detail Base </figcaption>
</figure>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Function to clip values from 0 to 1, ignore negative values and values above 1</span>
<span class="k">def</span> <span class="nf">clipping</span><span class="p">(</span><span class="n">matrix</span><span class="p">):</span>
    <span class="n">matrix</span><span class="p">[</span><span class="n">matrix</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">matrix</span><span class="p">[</span><span class="n">matrix</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">matrix</span><span class="o">*</span><span class="mi">255</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">matrix</span>

<span class="c1">### Final Step</span>
<span class="c1">### Merge the base and detail layer</span>
<span class="k">def</span> <span class="nf">final_merge</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">detail</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
    <span class="n">r</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">detail</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">GaussianBlur</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span><span class="o">*</span><span class="mi">6</span> <span class="c1"># improve contrast in red</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">GaussianBlur</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span><span class="o">*</span><span class="mi">6</span> <span class="c1"># improve contrast in green</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>                 <span class="c1"># make blue detail zero</span>
    
    <span class="n">rr</span> <span class="o">=</span> <span class="n">base</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">r</span>  <span class="c1"># red base + detail</span>
    <span class="n">gg</span> <span class="o">=</span> <span class="n">base</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">g</span>  <span class="c1"># green base + detail</span>
    <span class="n">bb</span> <span class="o">=</span> <span class="n">base</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span> <span class="c1"># blue base + zero detail</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">merge</span><span class="p">((</span><span class="n">rr</span><span class="p">,</span><span class="n">gg</span><span class="p">,</span><span class="n">bb</span><span class="p">))</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">clipping</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">rev_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_RGB2BGR</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s1">&#39;saved/&#39;</span><span class="o">+</span><span class="n">num</span><span class="o">+</span><span class="s1">&#39;_output.png&#39;</span><span class="p">,</span> <span class="n">rev_img</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">image</span>


<span class="n">number</span> <span class="o">=</span> <span class="s1">&#39;01&#39;</span>
<span class="n">img_path</span> <span class="o">=</span> <span class="s1">&#39;test/images/&#39;</span><span class="o">+</span><span class="n">number</span><span class="o">+</span><span class="s1">&#39;_test.tif&#39;</span>
<span class="n">mask_path</span> <span class="o">=</span> <span class="s1">&#39;test/mask/&#39;</span><span class="o">+</span><span class="n">number</span><span class="o">+</span><span class="s1">&#39;_test_mask.png&#39;</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>

<span class="n">cimg</span> <span class="o">=</span> <span class="n">save_clahe_images</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>
<span class="n">noise</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">detail</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">decomposition</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">mask_path</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>
<span class="n">new_base</span> <span class="o">=</span> <span class="n">base_enhancement</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">final_merge</span><span class="p">(</span><span class="n">new_base</span><span class="p">,</span> <span class="n">detail</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Original Image&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cimg</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;CLAHE&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Proposed Method&#39;</span><span class="p">)</span>
</code></pre></div><figure>
 <div class="column">
    <p align="center"><img class=scaled src="/projectimages/retina/01_test.png" width="200">
<img class=scaled src="/projectimages/retina/01_clahe.png" width="200">
<img class=scaled src="/projectimages/retina/01_output.png" width="200">
</div>
  <figcaption>a. Original Image b. CLAHE c. Proposed Method</figcaption>
</figure>

            </div>
        </article>
    </main>
</div>
<footer class="footer">
    

    <div class="footer_social-icons">
<a href="https://github.com/coolman-spaceman" target="_blank" rel="noopener noreferrer me" title="Github">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22">
    </path>
</svg>
</a>
<a href="https://www.linkedin.com/in/coolman-spaceman/" target="_blank" rel="noopener noreferrer me" title="Linkedin">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path>
    <rect x="2" y="9" width="4" height="12"></rect>
    <circle cx="4" cy="4" r="2"></circle>
</svg>
</a></div>
    
</footer>
<script src="https://coolman-spaceman.github.io/js/themeSwitchnMenu.min.f2fa3aed078bf5a7b612bf5548ddd0cb9891199ed24b5b673465df221e70bf4c.js"></script></body>
</html>
